<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FastLoop — Live Trading</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;700&family=Syne:wght@400;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #080b0f;
    --surface: #0d1117;
    --border: #1a2332;
    --border-bright: #243347;
    --text: #c8d6e8;
    --text-dim: #4a6080;
    --text-bright: #e8f0f8;
    --green: #00e676;
    --green-dim: #00c45a;
    --red: #ff3d57;
    --red-dim: #cc2a40;
    --amber: #ffb300;
    --blue: #2196f3;
    --blue-dim: #1565c0;
    --cyan: #00bcd4;
    --mono: 'JetBrains Mono', monospace;
    --display: 'Syne', sans-serif;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--mono);
    font-size: 12px;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Scanline overlay */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background: repeating-linear-gradient(
      0deg,
      transparent,
      transparent 2px,
      rgba(0,0,0,0.03) 2px,
      rgba(0,0,0,0.03) 4px
    );
    pointer-events: none;
    z-index: 1000;
  }

  /* ── Header ───────────────────────────────────────────── */
  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 20px;
    border-bottom: 1px solid var(--border);
    background: var(--surface);
    position: sticky;
    top: 0;
    z-index: 100;
  }
  .logo {
    font-family: var(--display);
    font-size: 18px;
    font-weight: 800;
    letter-spacing: -0.5px;
    color: var(--text-bright);
  }
  .logo span { color: var(--green); }
  .header-right { display: flex; align-items: center; gap: 20px; }

  .market-badge {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 4px 10px;
    border-radius: 2px;
    font-size: 11px;
    font-weight: 500;
    letter-spacing: 0.5px;
    text-transform: uppercase;
  }
  .market-badge.open   { background: rgba(0,230,118,0.1); border: 1px solid rgba(0,230,118,0.3); color: var(--green); }
  .market-badge.closed { background: rgba(255,61,87,0.1);  border: 1px solid rgba(255,61,87,0.3);  color: var(--red); }
  .market-badge.err    { background: rgba(255,61,87,0.1);  border: 1px solid rgba(255,61,87,0.3);  color: var(--red); }
  .badge-dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; }
  .badge-dot.pulse { animation: pulse 1.5s ease infinite; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.3} }

  .last-update { color: var(--text-dim); font-size: 10px; }
  .utc-clock { color: var(--text-bright); font-size: 12px; font-variant-numeric: tabular-nums; letter-spacing: 0.5px; }

  .refresh-btn {
    background: none;
    border: 1px solid var(--border-bright);
    color: var(--text-dim);
    padding: 3px 8px;
    font-family: var(--mono);
    font-size: 10px;
    cursor: pointer;
    border-radius: 2px;
    transition: all 0.15s;
  }
  .refresh-btn:hover { border-color: var(--green); color: var(--green); }

  /* ── Nav ──────────────────────────────────────────────── */
  .nav {
    display: flex;
    gap: 2px;
    padding: 0 20px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
  }
  .nav-link {
    padding: 8px 16px;
    font-size: 11px;
    letter-spacing: 0.5px;
    color: var(--text-dim);
    text-decoration: none;
    border-bottom: 2px solid transparent;
    transition: color 0.15s, border-color 0.15s;
    margin-bottom: -1px;
  }
  .nav-link:hover { color: var(--text-bright); }
  .nav-link.active { color: var(--text-bright); border-bottom-color: var(--green); }
  .nav-right { margin-left: auto; display: flex; align-items: center; }
  .nav-meta { font-size: 10px; color: var(--text-dim); }

  /* ── Scrollbar ────────────────────────────────────────── */
  ::-webkit-scrollbar { width: 4px; height: 4px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border-bright); border-radius: 2px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--text-dim); }

  /* ── Layout ───────────────────────────────────────────── */
  .layout {
    display: grid;
    grid-template-columns: 260px 1fr;
    min-height: calc(100vh - 82px);
    align-items: start;
  }

  /* ── Sidebar ──────────────────────────────────────────── */
  .sidebar {
    grid-row: 1 / 3;
    border-right: 1px solid var(--border);
    overflow-y: auto;
    background: var(--surface);
    position: sticky;
    top: 82px;
    height: calc(100vh - 82px);
    align-self: start;
  }
  .sidebar-section { border-bottom: 1px solid var(--border); padding: 14px 16px; }
  .section-label {
    font-size: 9px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--text-dim);
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .section-label-badge { font-size: 9px; letter-spacing: 0; text-transform: none; }
  .stat-row { display: flex; justify-content: space-between; align-items: center; padding: 3px 0; }
  .stat-label { color: var(--text-dim); font-size: 11px; }
  .stat-val { color: var(--text-bright); font-size: 11px; font-weight: 500; }
  .stat-val.green { color: var(--green); }
  .stat-val.red   { color: var(--red); }
  .stat-val.amber { color: var(--amber); }
  .stat-val.blue  { color: var(--blue); }
  .stat-val.cyan  { color: var(--cyan); }
  .stat-val.dim   { color: var(--text-dim); }

  /* Signal score */
  .sig-score-wrap { display: flex; align-items: flex-end; gap: 10px; margin-bottom: 6px; }
  .sig-score-big {
    font-family: var(--display);
    font-size: 42px;
    font-weight: 800;
    line-height: 1;
    color: var(--text-dim);
  }
  .sig-pill {
    display: inline-block;
    padding: 3px 10px 2px;
    font-family: var(--display);
    font-size: 13px;
    font-weight: 800;
    letter-spacing: 1px;
    border-radius: 2px;
    margin-bottom: 2px;
  }
  .sig-pill.yes { background: rgba(0,230,118,0.1); color: var(--green); border: 1px solid rgba(0,230,118,0.25); }
  .sig-pill.no  { background: rgba(255,61,87,0.1);  color: var(--red);   border: 1px solid rgba(255,61,87,0.25); }
  .sig-pill.blk { background: rgba(74,96,128,0.15); color: var(--text-dim); border: 1px solid var(--border-bright); }
  .sig-bar-track { height: 3px; background: var(--border); border-radius: 1px; overflow: hidden; margin-top: 4px; }
  .sig-bar-fill  { height: 100%; border-radius: 1px; transition: width 0.4s, background 0.4s; }
  .sig-filter { font-size: 10px; color: var(--amber); margin-top: 4px; }
  .sig-conf   { font-size: 10px; color: var(--text-dim); margin-top: 1px; }

  /* Progress bars */
  .progress-wrap { margin: 5px 0; }
  .progress-label { display: flex; justify-content: space-between; font-size: 9px; color: var(--text-dim); margin-bottom: 3px; }
  .progress-label span { color: var(--text); }
  .progress-track { height: 4px; background: var(--border); border-radius: 2px; overflow: hidden; }
  .progress-fill  { height: 100%; border-radius: 2px; background: var(--green); transition: width 0.4s, background 0.4s; }

  /* ── Main ─────────────────────────────────────────────── */
  .main { padding: 16px; display: flex; flex-direction: column; gap: 14px; }

  /* Stats strip */
  .stats-strip { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    padding: 12px 14px;
    border-radius: 2px;
    position: relative;
    overflow: hidden;
  }
  .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; }
  .stat-card.green-top::before { background: var(--green); }
  .stat-card.red-top::before   { background: var(--red); }
  .stat-card.amber-top::before { background: var(--amber); }
  .stat-card.blue-top::before  { background: var(--blue); }
  .stat-card.cyan-top::before  { background: var(--cyan); }
  .stat-card-label { font-size: 9px; letter-spacing: 1.5px; text-transform: uppercase; color: var(--text-dim); margin-bottom: 6px; }
  .stat-card-value { font-size: 22px; font-weight: 700; color: var(--text-bright); font-family: var(--display); line-height: 1; }
  .stat-card-sub   { font-size: 10px; color: var(--text-dim); margin-top: 4px; }

  /* Panels */
  .panel { background: var(--surface); border: 1px solid var(--border); border-radius: 2px; overflow: hidden; }
  .panel-header {
    padding: 10px 14px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .panel-title { font-size: 10px; letter-spacing: 2px; text-transform: uppercase; color: var(--text-dim); }
  .panel-meta  { font-size: 10px; color: var(--text-dim); }

  /* Two-column row */
  .panels-row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }

  /* Tab bar */
  .tab-bar { display: flex; gap: 4px; }
  .tab {
    padding: 4px 12px;
    font-size: 9px;
    letter-spacing: 1px;
    text-transform: uppercase;
    color: var(--text-dim);
    cursor: pointer;
    border: 1px solid var(--border);
    border-radius: 2px;
    background: none;
    font-family: var(--mono);
    transition: all 0.15s;
  }
  .tab:hover { color: var(--text-bright); border-color: var(--border-bright); }
  .tab.active { color: var(--green); border-color: var(--green); background: rgba(0,230,118,0.06); }

  /* Accuracy bar */
  .acc-bar-wrap { display: flex; align-items: center; gap: 10px; padding: 8px 14px; border-bottom: 1px solid var(--border); }
  .acc-lbl  { font-size: 10px; color: var(--text-dim); width: 90px; flex-shrink: 0; }
  .acc-lbl.r { text-align: right; }
  .acc-track { flex: 1; height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; display: flex; }
  .acc-yes   { height: 100%; background: var(--green); transition: width 0.4s; }
  .acc-no    { height: 100%; background: var(--red);   transition: width 0.4s; }
  .acc-note  { font-size: 10px; color: var(--text-dim); white-space: nowrap; }

  /* P&L chart */
  .pnl-chart { height: 80px; border-bottom: 1px solid var(--border); background: rgba(0,0,0,0.2); }
  .pnl-chart svg { display: block; width: 100%; height: 100%; }

  /* Trade table */
  .tbl-wrap { overflow: auto; max-height: 420px; }
  table.tbl { width: 100%; border-collapse: collapse; font-size: 11px; }
  table.tbl th {
    padding: 7px 10px;
    text-align: left;
    font-size: 9px;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--text-dim);
    border-bottom: 1px solid var(--border);
    font-weight: 400;
    background: var(--surface);
    position: sticky; top: 0; z-index: 10;
    white-space: nowrap;
  }
  table.tbl th.r { text-align: right; }
  table.tbl td   { padding: 6px 10px; border-bottom: 1px solid rgba(26,35,50,0.5); white-space: nowrap; }
  table.tbl td.r { text-align: right; }
  table.tbl tr:hover td { background: rgba(255,255,255,0.015); }
  table.tbl tr.win  td  { background: rgba(0,230,118,0.025); }
  table.tbl tr.loss td  { background: rgba(255,61,87,0.025); }
  table.tbl tr.open td  { background: rgba(33,150,243,0.02); }
  table.tbl tr:last-child td { border-bottom: none; }

  .rd { display: inline-block; width: 7px; height: 7px; border-radius: 50%; vertical-align: middle; margin-right: 4px; }
  .rd.win  { background: var(--green); box-shadow: 0 0 5px rgba(0,230,118,0.5); }
  .rd.loss { background: var(--red); }
  .rd.open { background: var(--blue); animation: pulse 2s infinite; }
  .rd.unk  { background: var(--text-dim); }

  .trade-pill { display: inline-block; padding: 1px 7px; border-radius: 2px; font-size: 9px; font-weight: 700; letter-spacing: 0.5px; }
  .trade-pill.yes { background: rgba(0,230,118,0.12); color: var(--green); border: 1px solid rgba(0,230,118,0.3); }
  .trade-pill.no  { background: rgba(255,61,87,0.12);  color: var(--red);   border: 1px solid rgba(255,61,87,0.3); }

  .out-pill { display: inline-block; padding: 2px 7px; border-radius: 2px; font-size: 9px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; }
  .out-pill.up   { background: rgba(0,230,118,0.12); color: var(--green); border: 1px solid rgba(0,230,118,0.3); }
  .out-pill.down { background: rgba(255,61,87,0.12);  color: var(--red);   border: 1px solid rgba(255,61,87,0.3); }

  /* Cycle feed */
  .feed-hdr {
    display: grid;
    grid-template-columns: 52px 68px 38px 72px 52px 1fr 52px;
    padding: 5px 10px;
    gap: 4px;
    background: rgba(0,0,0,0.2);
    border-bottom: 1px solid var(--border);
  }
  .feed-hcol { font-size: 9px; letter-spacing: 1px; text-transform: uppercase; color: var(--text-dim); }
  .feed-scroll { overflow-y: auto; max-height: 220px; }
  .feed-row {
    display: grid;
    grid-template-columns: 52px 68px 38px 72px 52px 1fr 52px;
    padding: 4px 10px;
    gap: 4px;
    border-bottom: 1px solid rgba(26,35,50,0.4);
    font-variant-numeric: tabular-nums;
  }
  .feed-row:hover  { background: rgba(255,255,255,0.02); }
  .feed-row.trade  { background: rgba(0,230,118,0.04); }
  .feed-col { font-size: 10px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: var(--text-dim); }
  .feed-col.g { color: var(--green); }
  .feed-col.r { color: var(--red); }
  .feed-col.t { color: var(--text); }

  .dp { font-size: 9px; font-weight: 700; padding: 1px 5px; border-radius: 2px; display: inline-block; white-space: nowrap; }
  .dp-trade   { background: rgba(0,230,118,0.13); color: var(--green); border: 1px solid rgba(0,230,118,0.3); }
  .dp-vol     { background: rgba(255,179,0,0.1);  color: var(--amber); border: 1px solid rgba(255,179,0,0.2); }
  .dp-neutral { background: rgba(33,150,243,0.08); color: var(--blue); border: 1px solid rgba(33,150,243,0.2); }
  .dp-block   { background: rgba(26,35,50,0.4);   color: var(--text-dim); border: 1px solid var(--border-bright); }

  /* Log */
  .log-scroll { overflow-y: auto; max-height: 252px; font-size: 10px; line-height: 1.6; }
  .log-line   { padding: 2px 14px; border-bottom: 1px solid rgba(26,35,50,0.3); white-space: pre-wrap; word-break: break-all; color: var(--text-dim); }
  .log-line.trade     { color: var(--green); background: rgba(0,230,118,0.03); }
  .log-line.error     { color: var(--red);   background: rgba(255,61,87,0.07); }
  .log-line.ratelimit { color: var(--red);   background: rgba(255,61,87,0.05); }
  .log-line.import    { color: var(--cyan); }

  /* Spinner / empty */
  .spinner {
    display: inline-block;
    width: 10px; height: 10px;
    border: 1.5px solid var(--border-bright);
    border-top-color: var(--green);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    vertical-align: middle;
    margin-right: 6px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loading { color: var(--text-dim); font-size: 11px; padding: 20px; text-align: center; }
  .empty   { padding: 30px; text-align: center; color: var(--text-dim); font-size: 11px; }
</style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <div class="logo">PKASEMER<span>NWITQ</span> <span style="font-size:11px;color:var(--text-dim);font-family:var(--mono);font-weight:400">/ live trading</span></div>
  <div class="header-right">
    <div id="market-badge" class="market-badge closed">
      <div class="badge-dot" id="badge-dot"></div>
      <span id="market-status-text">connecting...</span>
    </div>
    <span class="last-update">cycle <strong id="cnum" style="color:var(--text)">—</strong></span>
    <span class="utc-clock" id="clock">—</span>
    <button class="refresh-btn" onclick="refreshAll()">↺ refresh</button>
  </div>
</div>

<!-- NAV -->
<nav class="nav">
  <a href="index.html" class="nav-link">Monitor</a>
  <a href="dry-run.html" class="nav-link">Signal Lab</a>
  <a href="live.html" class="nav-link active">Live Trading</a>
  <div class="nav-right">
    <span class="nav-meta" id="last-ref">—</span>
  </div>
</nav>

<!-- LAYOUT -->
<div class="layout">

  <!-- ── SIDEBAR ─────────────────────────────────────────── -->
  <div class="sidebar">

    <!-- Current Signal -->
    <div class="sidebar-section">
      <div class="section-label">
        Current Signal
        <span class="section-label-badge" style="color:var(--text-dim)" id="sig-ts">—</span>
      </div>
      <div class="sig-score-wrap">
        <div class="sig-score-big" id="sig-score">—</div>
        <div>
          <div id="sig-pill"><span class="sig-pill blk">BLOCK</span></div>
          <div class="sig-conf" id="sig-conf">conf —</div>
        </div>
      </div>
      <div class="sig-bar-track"><div class="sig-bar-fill" id="sig-bar" style="width:50%;background:var(--border)"></div></div>
      <div class="sig-filter" id="sig-filter" style="display:none"></div>
      <div style="margin-top:8px">
        <div class="stat-row">
          <span class="stat-label">window</span>
          <span class="stat-val dim" id="sig-slug" style="font-size:9px;text-align:right;max-width:155px;word-break:break-all">—</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">secs left</span>
          <span class="stat-val" id="sig-secs">—</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">BTC price</span>
          <span class="stat-val amber" id="sig-price">—</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">vs ref</span>
          <span class="stat-val" id="sig-vs">—</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">momentum 5m</span>
          <span class="stat-val" id="sig-m5">—</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">poly yes</span>
          <span class="stat-val blue" id="sig-poly">—</span>
        </div>
      </div>
    </div>

    <!-- Import Health -->
    <div class="sidebar-section">
      <div class="section-label">
        Import Health
        <span class="section-label-badge" id="cache-badge" style="color:var(--text-dim)">—</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">imports today</span>
        <span class="stat-val" id="imp-today">—</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">cached slugs</span>
        <span class="stat-val" id="imp-cached">—</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">current window</span>
        <span class="stat-val" id="imp-current">—</span>
      </div>
      <div class="stat-row" style="margin-bottom:8px">
        <span class="stat-label">spent today</span>
        <span class="stat-val" id="imp-spent">—</span>
      </div>
      <div class="progress-wrap">
        <div class="progress-label">Import quota <span id="quota-lbl">0 / 9</span></div>
        <div class="progress-track"><div class="progress-fill" id="quota-fill" style="width:0%"></div></div>
      </div>
      <div class="progress-wrap">
        <div class="progress-label">Daily budget <span id="budget-lbl">$0</span></div>
        <div class="progress-track"><div class="progress-fill" id="budget-fill" style="width:0%"></div></div>
      </div>
    </div>

    <!-- Today's Decisions -->
    <div class="sidebar-section">
      <div class="section-label">
        Today's Decisions
        <span class="section-label-badge" id="dec-total" style="color:var(--text-dim)">—</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">would trade</span>
        <span class="stat-val green" id="dec-trade">—</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">blocked</span>
        <span class="stat-val dim" id="dec-blocked">—</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">trade rate</span>
        <span class="stat-val blue" id="dec-rate">—</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">avg score</span>
        <span class="stat-val" id="dec-score">—</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">top block</span>
        <span class="stat-val amber" id="dec-top" style="font-size:10px;text-align:right;max-width:140px;word-break:break-word">—</span>
      </div>
    </div>

  </div>

  <!-- ── MAIN ────────────────────────────────────────────── -->
  <div class="main">

    <!-- Stats strip -->
    <div class="stats-strip">
      <div class="stat-card green-top">
        <div class="stat-card-label">Today P&amp;L</div>
        <div class="stat-card-value" id="b-today-pnl" style="color:var(--text-dim)">—</div>
        <div class="stat-card-sub" id="b-today-n">0 trades</div>
      </div>
      <div class="stat-card blue-top">
        <div class="stat-card-label">All-time P&amp;L</div>
        <div class="stat-card-value" id="b-total-pnl" style="color:var(--text-dim)">—</div>
        <div class="stat-card-sub" id="b-total-n">—</div>
      </div>
      <div class="stat-card amber-top">
        <div class="stat-card-label">Win Rate</div>
        <div class="stat-card-value" id="b-wr" style="color:var(--text-dim)">—</div>
        <div class="stat-card-sub" id="b-wr-sub">resolved</div>
      </div>
      <div class="stat-card cyan-top">
        <div class="stat-card-label">Open Positions</div>
        <div class="stat-card-value" id="b-open" style="color:var(--text-dim)">—</div>
        <div class="stat-card-sub">awaiting resolve</div>
      </div>
      <div class="stat-card red-top">
        <div class="stat-card-label">Score: Win / Loss</div>
        <div class="stat-card-value" id="b-scores" style="color:var(--text-dim);font-size:16px">—</div>
        <div class="stat-card-sub">avg signal score</div>
      </div>
    </div>

    <!-- Cycle feed + Log -->
    <div class="panels-row">

      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">Recent Cycles</div>
          <div class="panel-meta" id="feed-n">—</div>
        </div>
        <div class="feed-hdr">
          <span class="feed-hcol">Time</span>
          <span class="feed-hcol">Slug</span>
          <span class="feed-hcol">Secs</span>
          <span class="feed-hcol">m5 / vsRef</span>
          <span class="feed-hcol">Score</span>
          <span class="feed-hcol">Decision</span>
          <span class="feed-hcol">Out</span>
        </div>
        <div class="feed-scroll" id="feed-body">
          <div class="loading"><span class="spinner"></span>waiting...</div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">Scheduler Log</div>
          <div class="panel-meta" id="log-n">—</div>
        </div>
        <div class="log-scroll" id="log-body">
          <div class="loading"><span class="spinner"></span>loading...</div>
        </div>
      </div>

    </div>

    <!-- Trades panel -->
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">Placed Trades</div>
        <div class="tab-bar">
          <button class="tab active" id="tab-all"   onclick="setTab('all')">All Time</button>
          <button class="tab"        id="tab-today" onclick="setTab('today')">Today</button>
          <button class="tab"        id="tab-open"  onclick="setTab('open')">Open</button>
          <button class="tab"        id="tab-won"   onclick="setTab('won')">Won</button>
          <button class="tab"        id="tab-lost"  onclick="setTab('lost')">Lost</button>
        </div>
      </div>

      <!-- Accuracy bar -->
      <div class="acc-bar-wrap" id="acc-wrap" style="display:none">
        <span class="acc-lbl" id="acc-yes-lbl">YES —</span>
        <div class="acc-track">
          <div class="acc-yes" id="acc-yes" style="width:50%"></div>
          <div class="acc-no"  id="acc-no"  style="width:50%"></div>
        </div>
        <span class="acc-lbl r" id="acc-no-lbl">NO —</span>
        <span class="acc-note" id="acc-note">—</span>
      </div>

      <!-- P&L chart -->
      <div class="pnl-chart">
        <svg id="pnl-svg" viewBox="0 0 1400 80" preserveAspectRatio="none"></svg>
      </div>

      <!-- Table -->
      <div class="tbl-wrap">
        <table class="tbl">
          <thead><tr>
            <th style="width:18px"></th>
            <th>Date / Time (UTC)</th>
            <th>Window</th>
            <th>Side</th>
            <th class="r">Amount</th>
            <th class="r">BTC Price</th>
            <th class="r">Score</th>
            <th class="r">Conf</th>
            <th class="r">m5 %</th>
            <th class="r">vs Ref %</th>
            <th class="r">Poly Yes</th>
            <th class="r">Secs Left</th>
            <th class="r">Filter</th>
            <th class="r">Outcome</th>
            <th class="r">P&amp;L</th>
          </tr></thead>
          <tbody id="tbl-body">
            <tr><td colspan="15" style="padding:30px;text-align:center;color:var(--text-dim)"><span class="spinner"></span>loading trades...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<script>
const API = window.location.origin;
const $   = id => document.getElementById(id);

// UTC clock
function tick() {
  const n = new Date();
  $('clock').textContent = [n.getUTCHours(), n.getUTCMinutes(), n.getUTCSeconds()]
    .map(x => String(x).padStart(2,'0')).join(':') + ' UTC';
}
setInterval(tick, 1000); tick();

// Formatters
const pct    = (v, d=3) => v == null ? '—' : (v >= 0 ? '+' : '') + v.toFixed(d) + '%';
const fix    = (v, d=2) => v == null ? '—' : v.toFixed(d);
const dollar = v => v == null ? '—' : (v >= 0 ? '+$' : '-$') + Math.abs(v).toFixed(2);
const mcol   = v => v == null ? 'var(--text-dim)' : v > 0.05 ? 'var(--green)' : v < -0.05 ? 'var(--red)' : 'var(--text)';
const scol   = s => s == null ? 'var(--text-dim)' : s > 0.65 ? 'var(--green)' : s < 0.35 ? 'var(--red)' : Math.abs(s - .5) > 0.1 ? 'var(--amber)' : 'var(--text)';
const pcol   = v => v == null ? 'var(--text-dim)' : v > 0 ? 'var(--green)' : v < 0 ? 'var(--red)' : 'var(--text)';

// ── Status ─────────────────────────────────────────────────
async function fetchStatus() {
  try {
    const d = await fetch(`${API}/api/status`).then(r => r.json());
    const badge = $('market-badge'), dot = $('badge-dot'), txt = $('market-status-text');
    if (d.error) {
      badge.className = 'market-badge err';
      dot.className   = 'badge-dot';
      txt.textContent = d.error;
      return;
    }
    badge.className = 'market-badge open';
    dot.className   = 'badge-dot pulse';
    txt.textContent = `${d.mode || '?'} · ${d.market_status || 'live'}`;
    $('cnum').textContent = d.cycle || '—';
  } catch(e) {
    $('market-badge').className = 'market-badge err';
    $('market-status-text').textContent = 'monitor unreachable';
  }
}

// ── Current signal ─────────────────────────────────────────
async function fetchCurrent() {
  try {
    const d = await fetch(`${API}/api/current`).then(r => r.json());
    if (d.error) return;

    $('sig-ts').textContent    = d.ts ? d.ts.slice(11, 19) : '—';
    $('sig-slug').textContent  = d.market_slug || '—';
    $('sig-secs').textContent  = d.seconds_remaining != null ? Math.round(d.seconds_remaining) + 's' : '—';
    $('sig-price').textContent = d.price_now ? '$' + Number(d.price_now).toLocaleString('en', {maximumFractionDigits:0}) : '—';

    const vsEl = $('sig-vs');
    vsEl.textContent = pct(d.btc_vs_reference, 4);
    vsEl.className   = 'stat-val ' + (d.btc_vs_reference > 0.02 ? 'green' : d.btc_vs_reference != null && d.btc_vs_reference < -0.02 ? 'red' : '');

    const m5El = $('sig-m5');
    m5El.textContent = pct(d.momentum_5m, 4);
    m5El.className   = 'stat-val ' + (d.momentum_5m > 0.05 ? 'green' : d.momentum_5m != null && d.momentum_5m < -0.05 ? 'red' : '');

    $('sig-poly').textContent = fix(d.poly_yes_price, 3);

    const s   = d.signal_score;
    const seE = $('sig-score');
    seE.textContent = s != null ? s.toFixed(3) : '—';
    seE.style.color = scol(s);

    const bar = $('sig-bar');
    if (s != null) {
      bar.style.width      = (s * 100) + '%';
      bar.style.background = s > 0.65 ? 'var(--green)' : s < 0.35 ? 'var(--red)' : 'var(--amber)';
    }
    $('sig-conf').textContent = d.signal_confidence != null ? 'conf ' + d.signal_confidence.toFixed(2) : 'conf —';

    const pill = $('sig-pill');
    if (d.would_trade && d.signal_side) {
      pill.innerHTML = `<span class="sig-pill ${d.signal_side}">${d.signal_side === 'yes' ? '▲ YES' : '▼ NO'}</span>`;
    } else {
      pill.innerHTML = `<span class="sig-pill blk">BLOCK</span>`;
    }
    const filt = $('sig-filter');
    if (d.filter_reason) { filt.textContent = d.filter_reason; filt.style.display = 'block'; }
    else                 { filt.style.display = 'none'; }
  } catch(e) {}
}

// ── Cycle feed ─────────────────────────────────────────────
async function fetchFeed() {
  try {
    const rows = await fetch(`${API}/api/cycle-feed`).then(r => r.json());
    if (rows.error) return;
    $('feed-n').textContent = rows.length + ' cycles';
    const body = $('feed-body');
    if (!rows.length) { body.innerHTML = '<div class="loading">no cycles yet</div>'; return; }
    body.innerHTML = rows.map(row => {
      const time = row.ts ? row.ts.slice(11, 19) : '—';
      const sc   = row.score != null ? row.score.toFixed(3) : '—';
      const dt   = row.decision_type || '';
      const pill = dt === 'trade'
        ? `<span class="dp dp-trade">${row.side === 'yes' ? '▲ YES' : '▼ NO'}</span>`
        : dt === 'block_volume'   ? `<span class="dp dp-vol">LOW VOL</span>`
        : dt === 'block_neutral'  ? `<span class="dp dp-neutral">NEUTRAL</span>`
        : dt === 'block_momentum' ? `<span class="dp dp-block">WEAK M</span>`
        : `<span class="dp dp-block">BLOCK</span>`;
      const out = row.outcome === 'up'   ? '<span style="color:var(--green)">▲</span>'
                : row.outcome === 'down' ? '<span style="color:var(--red)">▼</span>'
                : '<span style="color:var(--text-dim)">·</span>';
      return `<div class="feed-row${dt === 'trade' ? ' trade' : ''}">
        <span class="feed-col">${time}</span>
        <span class="feed-col" style="font-size:9px">${row.slug_short || '—'}</span>
        <span class="feed-col">${row.secs != null ? Math.round(row.secs) + 's' : '—'}</span>
        <span class="feed-col" style="font-size:9px">
          <span style="color:${mcol(row.m5)}">${pct(row.m5,3)}</span>
          <span style="color:var(--text-dim)"> / </span>
          <span style="color:${mcol(row.vs_ref)}">${pct(row.vs_ref,3)}</span>
        </span>
        <span class="feed-col" style="color:${scol(row.score)}">${sc}</span>
        <span class="feed-col">${pill}</span>
        <span class="feed-col">${out}</span>
      </div>`;
    }).join('');
  } catch(e) {}
}

// ── Log ────────────────────────────────────────────────────
let _logLen = 0;
async function fetchLog() {
  try {
    const d     = await fetch(`${API}/api/logs?n=150`).then(r => r.json());
    const lines = d.lines || [];
    $('log-n').textContent = (d.total_lines || lines.length) + ' lines';
    if (lines.length === _logLen) return;
    _logLen = lines.length;
    const body  = $('log-body');
    const atBot = body.scrollHeight - body.scrollTop - body.clientHeight < 50;
    body.innerHTML = lines.map(l => {
      const raw = l.raw
        .replace(/</g, '&lt;').replace(/>/g, '&gt;')
        .replace(/(\[LIVE\]|\[DRY\])/g, '<strong style="color:var(--cyan)">$1</strong>')
        .replace(/(WOULD_TRADE|TRADED)/g, '<strong style="color:var(--green)">$1</strong>')
        .replace(/(BLOCK:|SKIP:)/g, '<strong style="color:var(--amber)">$1</strong>')
        .replace(/(Rate limited|rate limited|429)/g, '<strong style="color:var(--red)">$1</strong>')
        .replace(/(score=[\d.]+)/g, '<span style="color:var(--blue)">$1</span>')
        .replace(/(→ YES|→ NO)/g, m => `<strong style="color:${m.includes('YES') ? 'var(--green)' : 'var(--red)'}">${m}</strong>`);
      return `<div class="log-line ${l.kind || 'info'}">${raw}</div>`;
    }).join('');
    if (atBot || _logLen < 10) body.scrollTop = body.scrollHeight;
  } catch(e) {}
}

// ── Trades ─────────────────────────────────────────────────
let _trades = [], _tab = 'all';

function setTab(tab) {
  _tab = tab;
  ['all','today','open','won','lost'].forEach(t => $('tab-' + t).classList.toggle('active', t === tab));
  renderTrades();
}

async function fetchTrades() {
  try {
    const [tData, aData, pData] = await Promise.all([
      fetch(`${API}/api/trades`).then(r => r.json()),
      fetch(`${API}/api/accuracy`).then(r => r.json()),
      fetch(`${API}/api/pnl-summary`).then(r => r.json()),
    ]);
    _trades = Array.isArray(tData) ? tData : [];

    // Stat cards
    const tp = $('b-today-pnl');
    tp.textContent = dollar(pData.today_pnl);
    tp.style.color = pcol(pData.today_pnl);
    $('b-today-n').textContent = (pData.today_trades || 0) + ' trades today';

    const ap = $('b-total-pnl');
    ap.textContent = dollar(pData.total_pnl);
    ap.style.color = pcol(pData.total_pnl);
    $('b-total-n').textContent = (pData.total_trades || 0) + ' all time';

    const wrE = $('b-wr');
    if (aData.win_rate != null) {
      const w = aData.win_rate;
      wrE.textContent = Math.round(w * 100) + '%';
      wrE.style.color = w > 0.56 ? 'var(--green)' : w < 0.45 ? 'var(--red)' : 'var(--amber)';
      $('b-wr-sub').textContent = aData.correct + '/' + aData.total + ' resolved';
    } else { wrE.textContent = '—'; }

    const openN = _trades.filter(t => !t.resolved || !t.outcome).length;
    const oe    = $('b-open');
    oe.textContent = openN;
    oe.style.color = openN > 0 ? 'var(--cyan)' : 'var(--text-dim)';

    if (aData.avg_score_correct != null || aData.avg_score_wrong != null) {
      $('b-scores').textContent =
        (aData.avg_score_correct || 0).toFixed(3) + ' / ' + (aData.avg_score_wrong || 0).toFixed(3);
    }

    // Accuracy bar
    if (aData.total > 0) {
      $('acc-wrap').style.display = 'flex';
      const y = aData.yes_total || 0, n = aData.no_total || 0, tot = y + n || 1;
      $('acc-yes').style.width    = (y / tot * 100).toFixed(1) + '%';
      $('acc-no').style.width     = (n / tot * 100).toFixed(1) + '%';
      $('acc-yes-lbl').textContent = 'YES ' + (aData.yes_wr != null ? Math.round(aData.yes_wr * 100) + '% WR' : '—') + ' (' + y + ')';
      $('acc-no-lbl').textContent  = 'NO '  + (aData.no_wr  != null ? Math.round(aData.no_wr  * 100) + '% WR' : '—') + ' (' + n + ')';
      $('acc-note').textContent    = aData.total + ' resolved · overall ' + Math.round(aData.win_rate * 100) + '%';
    }

    drawPnl(_trades.filter(t => t.trade_result != null).slice().reverse());
    renderTrades();
  } catch(e) { console.error('fetchTrades', e); }
}

function renderTrades() {
  const today = new Date().toISOString().slice(0, 10);
  let rows = _trades;
  if      (_tab === 'today') rows = _trades.filter(t => t.ts && t.ts.startsWith(today));
  else if (_tab === 'open')  rows = _trades.filter(t => !t.resolved || !t.outcome);
  else if (_tab === 'won')   rows = _trades.filter(t => (t.trade_side==='yes'&&t.outcome==='up') || (t.trade_side==='no'&&t.outcome==='down'));
  else if (_tab === 'lost')  rows = _trades.filter(t => {
    const s = t.trade_side, o = t.outcome;
    return (o==='up'||o==='down') && !((s==='yes'&&o==='up') || (s==='no'&&o==='down'));
  });

  const tbody = $('tbl-body');
  if (!rows.length) {
    const msgs = {all:'No trades recorded yet — set FASTLOOP_MODE=trade or both.',today:'No trades today.',open:'No open positions.',won:'No winning trades yet.',lost:'No losing trades yet.'};
    tbody.innerHTML = `<tr><td colspan="15" class="empty">${msgs[_tab] || 'No data.'}</td></tr>`;
    return;
  }

  tbody.innerHTML = rows.map(t => {
    const side = t.trade_side || '—', out = t.outcome, res = t.resolved;
    let dc = 'open', rc = 'open', outH = '<span style="color:var(--blue)">pending</span>';
    if (res && out === 'up')   { const won = side==='yes'; dc=won?'win':'loss'; rc=dc; outH=`<span class="out-pill up">▲ UP</span>`; }
    else if (res && out === 'down') { const won = side==='no';  dc=won?'win':'loss'; rc=dc; outH=`<span class="out-pill down">▼ DN</span>`; }
    else if (res) { dc='unk'; rc=''; outH='<span style="color:var(--text-dim)">unclear</span>'; }

    const pnl   = t.trade_result;
    const score = t.signal_score != null ? t.signal_score.toFixed(3) : '—';
    const conf  = t.signal_confidence != null ? t.signal_confidence.toFixed(2) : '—';
    const fr    = t.filter_reason ? `<span style="color:var(--text-dim);font-size:9px">${t.filter_reason.slice(0,28)}</span>` : '<span style="color:var(--text-dim)">—</span>';
    const price = t.price_now ? '$' + Number(t.price_now).toLocaleString('en', {maximumFractionDigits:0}) : '—';

    return `<tr class="${rc}">
      <td><span class="rd ${dc}"></span></td>
      <td><span style="color:var(--text)">${t.ts ? t.ts.slice(0,10) : '—'}</span> <span style="color:var(--text-dim)">${t.ts ? t.ts.slice(11,19) : '—'}</span></td>
      <td style="color:var(--text);font-size:10px">${(t.market_slug || '—').slice(-14)}</td>
      <td><span class="trade-pill ${side}">${side === 'yes' ? '▲ YES' : '▼ NO'}</span></td>
      <td class="r" style="color:var(--text)">${t.trade_amount ? '$' + t.trade_amount.toFixed(2) : '—'}</td>
      <td class="r" style="color:var(--text-dim)">${price}</td>
      <td class="r" style="color:${scol(t.signal_score)}">${score}</td>
      <td class="r" style="color:var(--text-dim)">${conf}</td>
      <td class="r" style="color:${mcol(t.momentum_5m)}">${pct(t.momentum_5m,3)}</td>
      <td class="r" style="color:${mcol(t.btc_vs_reference)}">${pct(t.btc_vs_reference,3)}</td>
      <td class="r" style="color:var(--text)">${fix(t.poly_yes_price,3)}</td>
      <td class="r" style="color:var(--text-dim)">${t.seconds_remaining != null ? Math.round(t.seconds_remaining) + 's' : '—'}</td>
      <td class="r">${fr}</td>
      <td class="r">${outH}</td>
      <td class="r" style="color:${pcol(pnl)};font-weight:600">${dollar(pnl)}</td>
    </tr>`;
  }).join('');
}

function drawPnl(trades) {
  const svg = $('pnl-svg');
  if (!trades.length) {
    svg.innerHTML = `<text x="700" y="46" text-anchor="middle" fill="rgba(255,255,255,0.07)" font-size="12" font-family="monospace">no resolved trades yet</text>`;
    return;
  }
  const W=1400, H=80, PAD=6;
  let cum = 0;
  const pts = trades.map((t,i) => { cum += t.trade_result || 0; return {x:i, y:cum, t}; });
  const minY = Math.min(0, ...pts.map(p => p.y));
  const maxY = Math.max(0, ...pts.map(p => p.y));
  const rng  = maxY - minY || 0.01;
  const n    = pts.length;
  const tx   = i => PAD + (i / Math.max(n-1,1)) * (W - PAD*2);
  const ty   = v => H - PAD - ((v - minY) / rng) * (H - PAD*2);
  const zY   = ty(0);
  const fin  = pts[n-1].y;
  const lc   = fin >= 0 ? '#00e676' : '#ff3d57';

  let area = `M${tx(0)},${zY}`;
  pts.forEach((p,i) => area += ` L${tx(i)},${ty(p.y)}`);
  area += ` L${tx(n-1)},${zY} Z`;
  const line = pts.map((p,i) => `${i===0?'M':'L'}${tx(i)},${ty(p.y)}`).join(' ');
  const dots = pts.map((p,i) => {
    const won = (p.t.trade_side==='yes'&&p.t.outcome==='up') || (p.t.trade_side==='no'&&p.t.outcome==='down');
    return `<circle cx="${tx(i)}" cy="${ty(p.y)}" r="2.5" fill="${won?'#00e676':'#ff3d57'}" opacity="0.85"/>`;
  }).join('');

  svg.innerHTML = `
    <defs><linearGradient id="pg" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0%" stop-color="${lc}" stop-opacity="0.12"/>
      <stop offset="100%" stop-color="${lc}" stop-opacity="0"/>
    </linearGradient></defs>
    <line x1="0" y1="${zY}" x2="${W}" y2="${zY}" stroke="rgba(255,255,255,0.06)" stroke-width="1" stroke-dasharray="6,4"/>
    <path d="${area}" fill="url(#pg)"/>
    <path d="${line}" fill="none" stroke="${lc}" stroke-width="1.5" stroke-linejoin="round"/>
    ${dots}
    <circle cx="${tx(n-1)}" cy="${ty(fin)}" r="4" fill="${lc}"/>
    <text x="${W-PAD-4}" y="${ty(fin)+(fin>=0?-7:16)}" text-anchor="end" fill="${lc}" font-size="10" font-family="monospace">${dollar(fin)}</text>
    <text x="${PAD+4}" y="${H-4}" fill="rgba(255,255,255,0.1)" font-size="9" font-family="monospace">${n} resolved · green=win · red=loss</text>`;
}

// ── Import status ──────────────────────────────────────────
async function fetchImportStatus() {
  try {
    const d = await fetch(`${API}/api/import-status`).then(r => r.json());
    $('imp-today').textContent  = d.imports_today + ' / ' + d.import_limit;
    $('imp-cached').textContent = d.cache_entries;
    const curEl = $('imp-current');
    curEl.textContent = d.current_cached ? '✓ cached' : '✗ missing';
    curEl.className   = 'stat-val ' + (d.current_cached ? 'green' : 'red');
    $('imp-spent').textContent  = '$' + (d.spent_today || 0).toFixed(2);

    const qPct  = Math.min((d.imports_today / d.import_limit) * 100, 100);
    const qFill = $('quota-fill');
    qFill.style.width      = qPct + '%';
    qFill.style.background = qPct > 80 ? 'var(--red)' : qPct > 55 ? 'var(--amber)' : 'var(--green)';
    $('quota-lbl').textContent = d.imports_today + ' / ' + d.import_limit;

    const bPct  = Math.min((d.spent_today / (d.daily_budget || 10)) * 100, 100);
    const bFill = $('budget-fill');
    bFill.style.width      = bPct + '%';
    bFill.style.background = bPct > 80 ? 'var(--red)' : bPct > 55 ? 'var(--amber)' : 'var(--green)';
    $('budget-lbl').textContent = '$' + (d.spent_today || 0).toFixed(2) + ' / $' + (d.daily_budget || 10).toFixed(0);

    const badge = $('cache-badge');
    if (!d.cache_exists)        { badge.textContent = 'NO CACHE'; badge.style.color = 'var(--red)'; }
    else if (!d.current_cached) { badge.textContent = 'STALE';    badge.style.color = 'var(--amber)'; }
    else                        { badge.textContent = 'OK';        badge.style.color = 'var(--green)'; }
  } catch(e) {}
}

// ── Decision stats ─────────────────────────────────────────
async function fetchDecisionStats() {
  try {
    const d = await fetch(`${API}/api/decision-stats`).then(r => r.json());
    if (d.error) return;
    $('dec-total').textContent   = d.total_today + ' cycles';
    $('dec-trade').textContent   = d.would_trade;
    $('dec-blocked').textContent = d.blocked;
    $('dec-rate').textContent    = d.trade_rate != null ? (d.trade_rate * 100).toFixed(1) + '%' : '—';
    $('dec-score').textContent   = d.avg_score != null ? d.avg_score.toFixed(3) : '—';
    const top = Object.entries(d.block_reasons || {}).sort((a,b) => b[1] - a[1])[0];
    $('dec-top').textContent     = top ? top[0] + ' (' + top[1] + ')' : '—';
  } catch(e) {}
}

// ── Refresh ────────────────────────────────────────────────
async function refreshAll() {
  await Promise.all([
    fetchStatus(), fetchCurrent(), fetchFeed(), fetchLog(),
    fetchTrades(), fetchImportStatus(), fetchDecisionStats()
  ]);
  $('last-ref').textContent = 'updated ' + new Date().toUTCString().slice(17,25) + ' UTC';
}

refreshAll();
setInterval(refreshAll, 10000);
</script>
</body>
</html>
