version: "3.9"

services:

  # ── Signal collector + trader (24/7) ─────────────────────────────────────
  collector:
    build:
      context: .
      dockerfile: Dockerfile.trader
    container_name: pknwitq-collector
    restart: unless-stopped
    environment:
      PKNWITQ_MODE: both          # collect | trade | both | dry
      PKNWITQ_INTERVAL: "60"       # seconds between cycles
      PKNWITQ_ASSET: BTC
      PKNWITQ_WINDOW: 5m
      DB_PATH: /data/signal_research.db
      LOG_LEVEL: INFO
    env_file: [.env]
    volumes:
      - pknwitq-data:/data
      - ./logs:/app/logs
    command: sh -c "python -u scheduler.py 2>&1 | tee /app/logs/collector.log"
    healthcheck:
      test: ["CMD", "python", "-c", "import os; os.path.exists('/data/status.json') or exit(1)"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ── Monitor API + Dashboard ───────────────────────────────────────────────
  monitor:
    build:
      context: .
      dockerfile: Dockerfile.monitor
    container_name: pknwitq-monitor
    restart: unless-stopped
    environment:
      DB_PATH: /data/signal_research.db
      LOG_LEVEL: INFO
      SECRET_KEY: "${SECRET_KEY}"
      USERS_DB_PATH: /data/users.db
    env_file: [.env]
    volumes:
      - pknwitq-data:/data          # shared with collector: status.json, db, cache, spend, trade_log.json
      - ./logs:/app/logs             # shared with collector: collector.log
      # ── Live code: only needs `docker compose restart monitor` after changes ──
      - ./monitor/monitor_api.py:/app/monitor_api.py
      - ./shared/composite_signal.py:/app/composite_signal.py
      - ./trader/config.json:/app/config.json
      # ── Dashboard HTML: no restart needed at all ────────────────────────────
      - ./dashboard:/app/dashboard:ro
    ports:
      - "5000:5000"
    command: python monitor_api.py
    depends_on:
      - collector
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:5000/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  pknwitq-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./data          # persists to ./data/ on host

# ── Reload behaviour ───────────────────────────────────────────────────────
#
#  Edit dashboard/*.html            → nothing (live via volume mount)
#  Edit monitor/monitor_api.py      → docker compose restart monitor
#  Edit shared/composite_signal.py  → docker compose restart monitor
#  Edit trader/*.py or config.json  → docker compose up -d --build collector
#  Change trader env vars           → docker compose up -d collector
#
# ── File locations ─────────────────────────────────────────────────────────
#
#  /data/signal_research.db     ← DB (shared volume, both containers)
#  /data/status.json            ← scheduler status (shared volume)
#  /data/market_id_cache.json   ← import cache (shared volume)
#  /data/daily_spend.json       ← budget + quota tracking (shared volume)
#  /app/logs/collector.log      ← unified stdout+stderr via tee (bind mount, both containers)
#  /data/trade_log.json         ← executed trades (shared volume, written by fast_trader)
#
# ── Usage ──────────────────────────────────────────────────────────────────
#
# Build and start:
#   docker compose up -d
#
# View logs:
#   docker compose logs -f collector
#   docker compose logs -f monitor
#
# Open dashboard:
#   http://localhost:5000/live.html
#
# Rebuild only trader after code changes:
#   docker compose up -d --build collector
#
# Switch to dry-run trading (no real trades):
#   Set PKNWITQ_MODE=dry, then: docker compose up -d collector
#
# Switch to live trading:
#   Set PKNWITQ_MODE=both (collect + trade simultaneously)
#   Ensure SIMMER_API_KEY is set in .env
#   docker compose up -d collector
#
# Seed import cache (run when quota is exhausted):
#   docker exec pknwitq-collector python seed_cache.py
#
# Run signal analysis:
#   docker exec pknwitq-collector python signal_research.py --analyze --min-n 30
#
# Export data:
#   docker exec pknwitq-collector python signal_research.py --export /data/signals.csv
#
# Stop everything:
#   docker compose down
#
# Wipe DB and start fresh:
#   docker compose down && rm -rf ./data && docker compose up -d
